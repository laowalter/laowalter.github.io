<!DOCTYPE html>
<html>
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie-edge">

    
    
    <link rel="stylesheet" href="/laowalter.github.io/sass/main.min.ef740697b92983f94ae209bb0e3184554cbc28dcfc08832347dacd426dc8d3a2.css">

</head>

    
<head>
    
    

    
    
    <link href="laowalter.github.iocss/section_number/section_number.css" rel="stylesheet" type="text/css">
    
</head>

    <body>

    <h1>Golang爬虫</h1>
    <p>Wed Jun 26, 2019</p>
    
    <a class="tag tag--primary tag--small"   href="laowalter.github.io"><font color="green">Home</font></a>

    
        
           <a class="tag tag--primary tag--small" href="laowalter.github.io/tags/go">go</a>
        
    

    <hr><br>
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#首先在服务器上安装最新版本的chrome-和-chromedriver">首先在服务器上安装最新版本的chrome 和 chromedriver</a></li>
<li><a href="#头部的包">头部的包</a></li>
<li><a href="#chrome-headless-配置">chrome headless 配置</a></li>
<li><a href="#启动chromedriver">启动chromedriver</a></li>
<li><a href="#解析html-文件">解析html 文件</a>
<ul>
<li><a href="#利用正则清洗-html-去掉特殊字符串等">利用正则清洗 html 去掉特殊字符串等。</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav><article>
    

<p>使用Golang+selenium 驱动 chrome headless 模式，再用 goquery 解析html 字符。</p>

<h3 id="首先在服务器上安装最新版本的chrome-和-chromedriver">首先在服务器上安装最新版本的chrome 和 chromedriver</h3>

<ol>
<li>emerge -avq www-cient/google-chrome</li>
<li><a href="https://sites.google.com/a/chromium.org/chromedriver/downloads">下载对应的chromedriver(链接)</a></li>
</ol>

<h3 id="头部的包">头部的包</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;bytes&#34;</span>
    <span style="color:#e6db74">&#34;fmt&#34;</span>
    <span style="color:#e6db74">&#34;github.com/PuerkitoBio/goquery&#34;</span>
    <span style="color:#e6db74">&#34;github.com/tebeka/selenium&#34;</span>
    <span style="color:#e6db74">&#34;github.com/tebeka/selenium/chrome&#34;</span>
    <span style="color:#e6db74">&#34;io/ioutil&#34;</span>
    <span style="color:#e6db74">&#34;log&#34;</span>
    <span style="color:#e6db74">&#34;strings&#34;</span>
)</code></pre></div>
<h3 id="chrome-headless-配置">chrome headless 配置</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">port</span> = <span style="color:#ae81ff">9515</span> <span style="color:#75715e">// chromdriver service port
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">frameHtml</span> <span style="color:#66d9ef">string</span>

    <span style="color:#75715e">// 设置chrome的基本特性
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">caps</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">selenium</span>.<span style="color:#a6e22e">Capabilities</span>{<span style="color:#e6db74">&#34;browserName&#34;</span>: <span style="color:#e6db74">&#34;chrome&#34;</span>}

    <span style="color:#75715e">// 禁止加载图片，加快渲染速度
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">imgCaps</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}{
        <span style="color:#e6db74">&#34;profile.managed_default_content_settings.images&#34;</span>: <span style="color:#ae81ff">2</span>,
    }

    <span style="color:#a6e22e">chromeCaps</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chrome</span>.<span style="color:#a6e22e">Capabilities</span>{
        <span style="color:#a6e22e">Prefs</span>: <span style="color:#a6e22e">imgCaps</span>,
        <span style="color:#a6e22e">Path</span>:  <span style="color:#e6db74">&#34;&#34;</span>,
        <span style="color:#a6e22e">Args</span>: []<span style="color:#66d9ef">string</span>{
            <span style="color:#e6db74">&#34;--headless&#34;</span>,
            <span style="color:#e6db74">&#34;--start-maximized&#34;</span>,
            <span style="color:#e6db74">&#34;--window-size=1920x1920&#34;</span>,
            <span style="color:#e6db74">&#34;--no-sandbox&#34;</span>,
            <span style="color:#e6db74">&#34;--user-agent=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 Safari/537.36&#34;</span>,
            <span style="color:#e6db74">&#34;--disable-gpu&#34;</span>,
            <span style="color:#e6db74">&#34;--disable-impl-side-painting&#34;</span>,
            <span style="color:#e6db74">&#34;--disable-gpu-sandbox&#34;</span>,
            <span style="color:#e6db74">&#34;--disable-accelerated-2d-canvas&#34;</span>,
            <span style="color:#e6db74">&#34;--disable-accelerated-jpeg-decoding&#34;</span>,
            <span style="color:#e6db74">&#34;--test-type=ui&#34;</span>,
        },
    }
    <span style="color:#a6e22e">caps</span>.<span style="color:#a6e22e">AddChrome</span>(<span style="color:#a6e22e">chromeCaps</span>)</code></pre></div>
<h3 id="启动chromedriver">启动chromedriver</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#75715e">//selenium.NewChromeDriverService(&#34;chromedriver&#34;, port, opts...)
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">selenium</span>.<span style="color:#a6e22e">NewChromeDriverService</span>(<span style="color:#e6db74">&#34;chromedriver&#34;</span>, <span style="color:#a6e22e">port</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Error starting the ChromeDriver server: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
    }
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">Stop</span>()

    <span style="color:#75715e">// 启动chromeless浏览器
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">wd</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">selenium</span>.<span style="color:#a6e22e">NewRemote</span>(<span style="color:#a6e22e">caps</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;http://localhost:%d/wd/hub&#34;</span>, <span style="color:#a6e22e">port</span>))
    <span style="color:#a6e22e">check</span>(<span style="color:#a6e22e">err</span>)
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wd</span>.<span style="color:#a6e22e">Quit</span>()


<span style="color:#960050;background-color:#1e0010">###</span> <span style="color:#a6e22e">加载一个网页地址是url</span>

<span style="color:#e6db74">``</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">go</span>
    <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">wd</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">url</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Failed to load page: %s\n&#34;</span>, <span style="color:#a6e22e">err</span>))
    }

    <span style="color:#75715e">// 运行页面的javascript，可能会出现无法执行或者执行错误的情况，直到timeout
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">jsRt</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">wd</span>.<span style="color:#a6e22e">ExecuteScript</span>(<span style="color:#e6db74">&#34;return document.readyState&#34;</span>, <span style="color:#66d9ef">nil</span>)
    <span style="color:#a6e22e">check</span>(<span style="color:#a6e22e">err</span>)
    <span style="color:#75715e">//fmt.Println(&#34;网页的Javascript加载: &#34;, jsRt)
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">jsRt</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;complete&#34;</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;网页加载未完成&#34;</span>)
    }</code></pre></div>
<h3 id="解析html-文件">解析html 文件</h3>

<h4 id="利用正则清洗-html-去掉特殊字符串等">利用正则清洗 html 去掉特殊字符串等。</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    &lt;!<span style="color:#f92672">--</span>!<span style="color:#f92672">--</span>&gt; 
    &lt;<span style="color:#a6e22e">script</span>&gt;
    &lt;<span style="color:#a6e22e">header</span>&gt; </code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">doc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">goquery</span>.<span style="color:#a6e22e">Document</span>
<span style="color:#a6e22e">doc</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">goquery</span>.<span style="color:#a6e22e">NewDocumentFromReader</span>(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewReader</span>([]byte(<span style="color:#a6e22e">frameHtml</span>)))
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	<span style="color:#66d9ef">return</span>
}

<span style="color:#a6e22e">doc</span> = <span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">body</span>() <span style="color:#75715e">//只解析&lt;body&gt;部分
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">doc</span>.<span style="color:#a6e22e">Find</span>(<span style="color:#e6db74">&#34;li.s-result-item&#34;</span>).<span style="color:#a6e22e">Each</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">liIndex</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">liItem</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">goquery</span>.<span style="color:#a6e22e">Selection</span>) {
	<span style="color:#75715e">// do something
</span><span style="color:#75715e"></span>})</code></pre></div>
</article>

    </body>
</html>
