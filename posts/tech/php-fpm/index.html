<!DOCTYPE html>
<html>
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie-edge">

    
    
    <link rel="stylesheet" href="http://memo.eliglad.com/sass/main.min.25934bb03db303dfa541f621fc29b24509d8e2c2e39a063de4a77a16ab2fec19.css">

</head>

    
<head>
    
    

    
    
    <link href="http://memo.eliglad.comcss/section_number/section_number.css" rel="stylesheet" type="text/css">
    
</head>

    <body>

    <h1>Php-fpm</h1>
    <p>Sun Dec 2, 2018</p>
    
    <a class="tag tag--primary tag--small"   href="http://memo.eliglad.com"><font color="green">Home</font></a>

    
        
           <a class="tag tag--primary tag--small" href="http://memo.eliglad.com/tags/php">php</a>
        
           <a class="tag tag--primary tag--small" href="http://memo.eliglad.com/tags/nginx">nginx</a>
        
    

    <hr><br>
<nav id="TableOfContents">
<ul>
<li><a href="#install-upgrade-php-fpm">Install /Upgrade php-fpm</a>
<ul>
<li><a href="#config-etc-php-fpm-php7-2-fpm-d-www-conf">Config /etc/php/fpm-php7.2/fpm.d/www.conf</a></li>
<li><a href="#adjust-upload-limited">Adjust upload limited</a></li>
<li><a href="#etc-ngnix-nginx-conf">/etc/ngnix/nginx.conf</a></li>
</ul></li>
<li><a href="#add-php-fpm-to-default-service">Add php-fpm to default service</a></li>
<li><a href="#setup-php-fpm-in-nginx">Setup php-fpm in nginx</a>
<ul>
<li><a href="#简单的只用一个nginx-conf的做法">简单的只用一个nginx.conf的做法</a></li>
<li><a href="#如果是多层次-nginx-配置为文件">如果是多层次 nginx 配置为文件</a></li>
</ul></li>
</ul></li>
</ul>
</nav><article>
    

<h2 id="install-upgrade-php-fpm">Install /Upgrade php-fpm</h2>

<h3 id="config-etc-php-fpm-php7-2-fpm-d-www-conf">Config /etc/php/fpm-php7.2/fpm.d/www.conf</h3>

<div class="file" >
    
    <div class="filename" >
        <p style="padding:0; margin:0;">filename: <b>/etc/php/fpm-php7.2/fpm.d/www.conf</b></p>
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">  listen <span style="color:#f92672">=</span> /run/php-fpm.socket
  listen.owner <span style="color:#f92672">=</span> nginx
  listen.group <span style="color:#f92672">=</span> nginx
  listen.mode <span style="color:#f92672">=</span> <span style="color:#ae81ff">0660</span></code></pre></div>
    </div>
</div>

<h3 id="adjust-upload-limited">Adjust upload limited</h3>

<div class="file" >
    
    <div class="filename" >
        <p style="padding:0; margin:0;">filename: <b>/etc/php/fpm-php7.2/php.ini</b></p>
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">upload_tmp_dir <span style="color:#f92672">=</span> /tmp
upload_max_filesize <span style="color:#f92672">=</span> 20M</code></pre></div>
    </div>
</div>

<h3 id="etc-ngnix-nginx-conf">/etc/ngnix/nginx.conf</h3>

<div class="file" >
    
    <div class="filename" >
        <p style="padding:0; margin:0;">filename: <b>/etc/ngnix/nginx.conf</b></p>
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">client_max_body_size 20M;
client_body_buffer_size 128k;</code></pre></div>
    </div>
</div>

<h2 id="add-php-fpm-to-default-service">Add php-fpm to default service</h2>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># sudo  /etc/init.d/php-fpm start</span>
<span style="color:#75715e"># rc-update add php-fpm default</span></code></pre></div>

<h2 id="setup-php-fpm-in-nginx">Setup php-fpm in nginx</h2>

<h3 id="简单的只用一个nginx-conf的做法">简单的只用一个nginx.conf的做法</h3>

<div class="file" >
    
    <div class="filename" >
        <p style="padding:0; margin:0;">filename: <b>/etc/ngnix/nginx.conf</b></p>
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">server</span> {
    <span style="color:#f92672">listen</span> 0.0.0.0:<span style="color:#ae81ff">7001</span>;
    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">pannel</span>;
    <span style="color:#f92672">access_log</span> <span style="color:#e6db74">/var/log/pannel.log</span> <span style="color:#e6db74">main</span>;
    <span style="color:#f92672">error_log</span> <span style="color:#e6db74">/var/log/pannel.info</span> <span style="color:#e6db74">error</span>;

    <span style="color:#f92672">root</span> <span style="color:#e6db74">/var/www/localhost/htdocs/pannel</span>;
    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
            <span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span>;
            <span style="color:#f92672">fastcgi_index</span> <span style="color:#e6db74">index.html</span>;
    }
    <span style="color:#f92672">location</span> ~ <span style="color:#e6db74">\.php$</span> {
            <span style="color:#f92672">try_files</span> $uri =<span style="color:#ae81ff">404</span>;
            <span style="color:#f92672">include</span> <span style="color:#e6db74">/etc/nginx/fastcgi.conf</span>;
            <span style="color:#f92672">fastcgi_pass</span> <span style="color:#e6db74">unix:/run/php-fpm.socket</span>;
    }</code></pre></div>
    </div>
</div>

<h3 id="如果是多层次-nginx-配置为文件">如果是多层次 nginx 配置为文件</h3>

<ul>
<li><p>目录结构</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/etc/nginx
    |
    --nginx.conf
    |
    --conf.d/
           |
           --piwigo.conf</code></pre></div></li>

<li><p>相关文件内容</p></li>
</ul>

<div class="file" >
    
    <div class="filename" >
        <p style="padding:0; margin:0;">filename: <b>/etc/ngnix/nginx.conf</b></p>
        
    </div>
</div>

<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">user</span> <span style="color:#e6db74">nginx</span> <span style="color:#e6db74">nginx</span>;
<span style="color:#66d9ef">worker_processes</span> <span style="color:#ae81ff">1</span>;

<span style="color:#66d9ef">error_log</span> <span style="color:#e6db74">/var/log/nginx/error_log</span> <span style="color:#e6db74">info</span>;

<span style="color:#66d9ef">events</span> {
	<span style="color:#f92672">worker_connections</span> <span style="color:#ae81ff">1024</span>;
	<span style="color:#f92672">use</span> <span style="color:#e6db74">epoll</span>;
}

<span style="color:#66d9ef">http</span> {
	<span style="color:#f92672">include</span> <span style="color:#e6db74">/etc/nginx/mime.types</span>;
	<span style="color:#f92672">default_type</span> <span style="color:#e6db74">application/octet-stream</span>;

	<span style="color:#f92672">log_format</span> <span style="color:#e6db74">main</span>
		<span style="color:#e6db74">&#39;</span>$remote_addr <span style="color:#e6db74">-</span> $remote_user <span style="color:#e6db74">[</span>$time_local] <span style="color:#e6db74">&#39;</span>
		<span style="color:#e6db74">&#39;&#34;</span>$request&#34; $status $bytes_sent <span style="color:#e6db74">&#39;</span>
		<span style="color:#e6db74">&#39;&#34;</span>$http_referer&#34; <span style="color:#e6db74">&#34;</span>$http_user_agent&#34; <span style="color:#e6db74">&#39;</span>
		<span style="color:#e6db74">&#39;&#34;</span>$gzip_ratio&#34;&#39;;

	<span style="color:#f92672">client_header_timeout</span> <span style="color:#ae81ff">10m</span>;
	<span style="color:#f92672">client_body_timeout</span> <span style="color:#ae81ff">10m</span>;
	<span style="color:#f92672">send_timeout</span> <span style="color:#ae81ff">10m</span>;

	<span style="color:#f92672">connection_pool_size</span> <span style="color:#ae81ff">256</span>;
	<span style="color:#f92672">client_header_buffer_size</span> <span style="color:#ae81ff">1k</span>;
	<span style="color:#f92672">large_client_header_buffers</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">2k</span>;
	<span style="color:#f92672">request_pool_size</span> <span style="color:#ae81ff">4k</span>;

	<span style="color:#75715e"># piwigo
</span><span style="color:#75715e"></span>	<span style="color:#f92672">client_max_body_size</span> <span style="color:#e6db74">20M</span>;
	<span style="color:#f92672">client_body_buffer_size</span> <span style="color:#ae81ff">128k</span>;

	<span style="color:#f92672">gzip</span> <span style="color:#66d9ef">off</span>;

	<span style="color:#f92672">output_buffers</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">32k</span>;
	<span style="color:#f92672">postpone_output</span> <span style="color:#ae81ff">1460</span>;

	<span style="color:#f92672">sendfile</span> <span style="color:#66d9ef">on</span>;
	<span style="color:#f92672">tcp_nopush</span> <span style="color:#66d9ef">on</span>;
	<span style="color:#f92672">tcp_nodelay</span> <span style="color:#66d9ef">on</span>;

	<span style="color:#f92672">keepalive_timeout</span> <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">20</span>;

	<span style="color:#f92672">ignore_invalid_headers</span> <span style="color:#66d9ef">on</span>;

	<span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span>;

	<span style="color:#f92672">include</span> <span style="color:#e6db74">/etc/nginx/conf.d/*.conf</span>;
}</code></pre></td></tr></table>
</div>
</div>

<p><br></p>

<div class="file" >
    
    <div class="filename" >
        <p style="padding:0; margin:0;">filename: <b>/etc/nginx/conf.d/piwigo.conf</b></p>
        
    </div>
</div>

<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"> <span style="color:#66d9ef">server</span> {
 	<span style="color:#f92672">listen</span> 0.0.0.0:<span style="color:#ae81ff">3128</span>;
 	<span style="color:#f92672">server_name</span> <span style="color:#e6db74">photo</span>;
 	<span style="color:#75715e">#root /var/www/localhost/;
</span><span style="color:#75715e"></span> 	<span style="color:#f92672">root</span> <span style="color:#e6db74">/var/www/localhost/htdocs/piwigo</span>;
 
 	<span style="color:#f92672">location</span> <span style="color:#e6db74">@rewrite</span> {
     	<span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/picture((/|</span>$<span style="color:#e6db74">).*)</span>$ <span style="color:#e6db74">/picture.php</span>$1 <span style="color:#e6db74">last</span>;
     	<span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/index((/|</span>$<span style="color:#e6db74">).*)</span>$ <span style="color:#e6db74">/index.php</span>$1 <span style="color:#e6db74">last</span>;
     	<span style="color:#75715e"># The following is needed for batch operations which use i.php
</span><span style="color:#75715e"></span>     	<span style="color:#f92672">rewrite</span> <span style="color:#e6db74">^/piwigo/i((/|</span>$<span style="color:#e6db74">).*)</span>$ <span style="color:#e6db74">/piwigo/i.php</span>$1 <span style="color:#e6db74">last</span>;
 	}
 
 	<span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
     		<span style="color:#f92672">index</span> <span style="color:#e6db74">index.php</span>;
     		<span style="color:#f92672">try_files</span> $uri $uri/ <span style="color:#e6db74">@rewrite</span>;
 }	
    	<span style="color:#f92672">location</span> ~ <span style="color:#e6db74">\.php$</span> {
        		<span style="color:#f92672">try_files</span> $uri =<span style="color:#ae81ff">404</span>;
        		<span style="color:#f92672">include</span> <span style="color:#e6db74">/etc/nginx/fastcgi.conf</span>;
        		<span style="color:#f92672">fastcgi_pass</span> <span style="color:#e6db74">unix:/run/php-fpm.socket</span>;
   	}
 }</code></pre></td></tr></table>
</div>
</div>

</article>

    </body>
</html>
