<!DOCTYPE html>
<html>
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie-edge">

    
    <link href="https://fonts.font.im/css?family=Baloo+Bhaina" rel="stylesheet">

    
    
    <link rel="stylesheet" href="/sass/main.min.6e3c2b079ee31b17abb26d025a098c60ce82093b938c09a95277f558ea824d75.css">

</head>

    
<head>
    
    

    
    
    
    <link href="/css/section_number/section_number.css" rel="stylesheet" type="text/css">
    
</head>

    <body>
       <div class="homepage-header">
          <div class="homepage-left">
            <h1>WiFi-AP</h1> 
            <p style="font-family:  'Baloo Bhaina', cursive; color: #003366;">Thu, Nov 16, 2017</p>
            <a class="tag tag--primary tag--small"   href="/"><font color="green">Home</font></a>

            
                
                    
                    <a class="tag tag--primary tag--small" href="/tags/gentoo">gentoo</a>
                
                    
                    <a class="tag tag--primary tag--small" href="/tags/wifi">wifi</a>
                
            
          </div>
      </div>

    <hr><br><nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#check-hardware">Check hardware</a></li>
<li><a href="#kernel-config">Kernel config</a></li>
<li><a href="#intall-package">Intall package</a></li>
<li><a href="#by-wpa-supplicant">By wpa_supplicant</a>
<ul>
<li><a href="#dhcp-server">DHCP server</a></li>
<li><a href="#start-wifi-interface-controlled-by-wpa-supplicant-and-dhcp-server">Start wifi interface, controlled by wpa_supplicant and DHCP server:</a></li>
<li><a href="#set-for-permanent-etc-conf-d-net">Set for permanent /etc/conf.d/net</a></li>
<li><a href="#add-route">Add route</a></li>
</ul></li>
<li><a href="#default-services">Default services</a></li>
<li><a href="#by-hostapd">By hostapd</a></li>
<li><a href="#default-service">Default service</a></li>
</ul></li>
</ul></li>
</ul>
</nav><article>
    

<h3 id="check-hardware">Check hardware</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">lspci -n | grep 14e4</code></pre></div>
<h3 id="kernel-config">Kernel config</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">CONFIG_WLAN_VENDOR_BROADCOM<span style="color:#f92672">=</span>y
CONFIG_B43<span style="color:#f92672">=</span>m
CONFIG_B43_BCMA<span style="color:#f92672">=</span>y
CONFIG_B43_SSB<span style="color:#f92672">=</span>y
CONFIG_B43_BUSES_BCMA_AND_SSB<span style="color:#f92672">=</span>y
<span style="color:#75715e"># CONFIG_B43_BUSES_BCMA is not set</span>
<span style="color:#75715e"># CONFIG_B43_BUSES_SSB is not set</span>
CONFIG_B43_PCI_AUTOSELECT<span style="color:#f92672">=</span>y
CONFIG_B43_PCICORE_AUTOSELECT<span style="color:#f92672">=</span>y
CONFIG_B43_SDIO<span style="color:#f92672">=</span>y
CONFIG_B43_BCMA_PIO<span style="color:#f92672">=</span>y
CONFIG_B43_PIO<span style="color:#f92672">=</span>y
CONFIG_B43_PHY_G<span style="color:#f92672">=</span>y
CONFIG_B43_PHY_N<span style="color:#f92672">=</span>y
CONFIG_B43_PHY_LP<span style="color:#f92672">=</span>y
CONFIG_B43_PHY_HT<span style="color:#f92672">=</span>y
CONFIG_B43_HWRNG<span style="color:#f92672">=</span>y
<span style="color:#75715e"># CONFIG_B43_DEBUG is not set</span>
CONFIG_B43LEGACY<span style="color:#f92672">=</span>m
CONFIG_B43LEGACY_PCI_AUTOSELECT<span style="color:#f92672">=</span>y
CONFIG_B43LEGACY_PCICORE_AUTOSELECT<span style="color:#f92672">=</span>y
CONFIG_B43LEGACY_HWRNG<span style="color:#f92672">=</span>y
CONFIG_B43LEGACY_DEBUG<span style="color:#f92672">=</span>y
CONFIG_B43LEGACY_DMA<span style="color:#f92672">=</span>y
CONFIG_B43LEGACY_PIO<span style="color:#f92672">=</span>y
CONFIG_B43LEGACY_DMA_AND_PIO_MODE<span style="color:#f92672">=</span>y
<span style="color:#75715e"># CONFIG_B43LEGACY_DMA_MODE is not set</span>
<span style="color:#75715e"># CONFIG_B43LEGACY_PIO_MODE is not set</span>
CONFIG_BRCMUTIL<span style="color:#f92672">=</span>m
CONFIG_BRCMSMAC<span style="color:#f92672">=</span>m
CONFIG_BRCMFMAC<span style="color:#f92672">=</span>m
CONFIG_BRCMFMAC_PROTO_BCDC<span style="color:#f92672">=</span>y
CONFIG_BRCMFMAC_SDIO<span style="color:#f92672">=</span>y
<span style="color:#75715e"># CONFIG_BRCMFMAC_USB is not set</span>
<span style="color:#75715e"># CONFIG_BRCMFMAC_PCIE is not set</span></code></pre></div>
<h3 id="intall-package">Intall package</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">emerge -avq net-wireless/b43-fwcutter
emerge -avq sys-firmware/b43-firmware</code></pre></div>
<h3 id="by-wpa-supplicant">By wpa_supplicant</h3>

<p>Linux desktop connected to the Internet (wire, LTE modem) and it has a wifi card which is managed by wpa_supplicant, you can easily setup this computer as WiFi access point. You even don’t need hostapd - just wpa_supplicant and dhcp server software.</p>

<p>Configure wpa_supplicant.conf as follows (mode=2 is Access Point mode, for more see documentation):</p>

<ul>
<li><p>Find the hardware info</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">iw phy</code></pre></div></li>

<li><p>/etc/wpa_spplicant/wpa_supplicant.conf</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">network<span style="color:#f92672">={</span>
ssid<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;AP-NAME&#34;</span>
mode<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
key_mgmt<span style="color:#f92672">=</span>WPA-PSK
psk<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;password&#34;</span>
frequency<span style="color:#f92672">=</span><span style="color:#ae81ff">2462</span>
<span style="color:#f92672">}</span></code></pre></div></li>
</ul>

<p>You can choose right frequncy according to the table on wikipedia.</p>

<h4 id="dhcp-server">DHCP server</h4>

<ul>
<li><p>install dhcp with server use</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">su
echo ‘net-misc/dhcp server’ | sudo tee -a /etc/portage/package.use
emerge -avq net-misc/dhcp</code></pre></div></li>

<li><p>/etc/conf.d/dhpcd</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># /etc/conf.d/dhcpd: config file for /etc/init.d/dhcpd</span>

<span style="color:#75715e"># If you require more than one instance of dhcpd you can create symbolic</span>
<span style="color:#75715e"># links to dhcpd service like so</span>
<span style="color:#75715e">#   cd /etc/init.d</span>
<span style="color:#75715e">#   ln -s dhcpd dhcpd.foo</span>
<span style="color:#75715e">#   cd ../conf.d</span>
<span style="color:#75715e">#   cp dhcpd dhcpd.foo</span>
<span style="color:#75715e"># Now you can edit dhcpd.foo and specify a different configuration file.</span>
<span style="color:#75715e"># You&#39;ll also need to specify a pidfile in that dhcpd.conf file.</span>
<span style="color:#75715e"># See the pid-file-name option in the dhcpd.conf man page for details.</span>

<span style="color:#75715e"># If you wish to run dhcpd in a chroot, uncomment the following line</span>
<span style="color:#75715e"># DHCPD_CHROOT=&#34;/var/lib/dhcp/chroot&#34;</span>

<span style="color:#75715e"># All file paths below are relative to the chroot.</span>
<span style="color:#75715e"># You can specify a different chroot directory but MAKE SURE it&#39;s empty.</span>

<span style="color:#75715e"># Specify a configuration file - the default is /etc/dhcp/dhcpd.conf</span>
DHCPD_CONF<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/dhcp/dhcpd.conf&#34;</span>

<span style="color:#75715e"># Configure which interface or interfaces to for dhcpd to listen on.</span>
<span style="color:#75715e"># List all interfaces space separated. If this is not specified then</span>
<span style="color:#75715e"># we listen on all interfaces.</span>
DHCPD_IFACE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;wlan0&#34;</span>

<span style="color:#75715e"># Insert any other dhcpd options - see the man page for a full list.</span>
<span style="color:#75715e"># DHCPD_OPTS=&#34;&#34;</span></code></pre></div></li>

<li><p>Configure /etc/dhcp/dhcpd.conf</p></li>
</ul>

<p><strong>特别说明</strong>，因为加入本地DNS服务器，所有要在本地DNS服务器的name.conf中，把192.168.6.0/24加入acl &ldquo;trusted&rdquo;. 负责无法解析。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">subnet <span style="color:#ae81ff">192</span>.168.6.0 netmask <span style="color:#ae81ff">255</span>.255.255.0 <span style="color:#f92672">{</span>
  interface wlan0;
  range <span style="color:#ae81ff">192</span>.168.6.20 <span style="color:#ae81ff">192</span>.168.6.30;
  option domain-name-servers <span style="color:#ae81ff">192</span>.168.0.199, <span style="color:#ae81ff">192</span>.168.0.1;
  option domain-search <span style="color:#e6db74">&#34;ghome&#34;</span>;
  option routers <span style="color:#ae81ff">192</span>.168.6.1;
  option broadcast-address <span style="color:#ae81ff">192</span>.168.6.255;
  default-lease-time <span style="color:#ae81ff">600</span>;
  max-lease-time <span style="color:#ae81ff">7200</span>;
<span style="color:#f92672">}</span></code></pre></div>
<h4 id="start-wifi-interface-controlled-by-wpa-supplicant-and-dhcp-server">Start wifi interface, controlled by wpa_supplicant and DHCP server:</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo /etc/init.d/net.wifi start
sudo ifconfig wifi <span style="color:#ae81ff">192</span>.168.6.1/24</code></pre></div>
<h4 id="set-for-permanent-etc-conf-d-net">Set for permanent /etc/conf.d/net</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">### WIRED to internet ###</span>
config_eth0<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;192.168.0.199 netmask 255.255.255.0 brd 192.168.0.255&#34;</span>
routes_eth0<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;default via 192.168.0.1&#34;</span>

<span style="color:#75715e">### WIFI ###</span>
modules_wlan0<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;wpa_supplicant&#34;</span>
config_wlan0<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;192.168.6.1/24&#34;</span>
wpa_supplicant_wlan0<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-Dnl80211 -d -f /var/log/wpa_supplicant.log&#34;</span></code></pre></div>
<h4 id="add-route">Add route</h4>

<p>假设192.168.0.199 wired to the Internet</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo echo <span style="color:#ae81ff">1</span> &gt; /proc/sys/net/ipv4/ip_forward
sudo iptables -t nat -A POSTROUTING --source <span style="color:#ae81ff">192</span>.168.6.0/24 -j SNAT --to <span style="color:#ae81ff">192</span>.168.0.199
sudo /etc/init.d/iptables save
sudo rc-update add iptables default</code></pre></div>
<p>/etc/sysctl.conf:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">net.ipv4.ip_forward <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span></code></pre></div>
<h3 id="default-services">Default services</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rc-update add wpa_supplicant default
rc-update add net.wlan0 default</code></pre></div>
<h3 id="by-hostapd">By hostapd</h3>

<ul>
<li><p>/etc/conf.d/net</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Disable wpa_supplicant first

<span style="color:#75715e">### WIRED ###</span>
config_eth0<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;192.168.0.199 netmask 255.255.255.0 brd 192.168.0.255&#34;</span>
routes_eth0<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;default via 192.168.0.1&#34;</span>

modules_wlan0<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;!wpa_supplicant&#34;</span>
<span style="color:#75715e">#wpa_supplicant_wlan0=&#34;-Dnl80211 -d -f /var/log/wpa_supplicant.log&#34;</span>
config_wlan0<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;192.168.6.1/24&#34;</span>
routes_wlan0<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;default via 192.168.0.1&#34;</span></code></pre></div></li>

<li><p>/etc/hostapd/hostapd.conf</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">interface<span style="color:#f92672">=</span>wlan0
driver<span style="color:#f92672">=</span>nl80211
logger_syslog<span style="color:#f92672">=</span>-1
logger_syslog_level<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
logger_stdout<span style="color:#f92672">=</span>-1
logger_stdout_level<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
ctrl_interface<span style="color:#f92672">=</span>/var/run/hostapd
ctrl_interface_group<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
ssid<span style="color:#f92672">=</span>test
hw_mode<span style="color:#f92672">=</span>g
channel<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
beacon_int<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>
dtim_period<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
max_num_sta<span style="color:#f92672">=</span><span style="color:#ae81ff">255</span>
rts_threshold<span style="color:#f92672">=</span>-1
fragm_threshold<span style="color:#f92672">=</span>-1
macaddr_acl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
auth_algs<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
ignore_broadcast_ssid<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
wmm_enabled<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
wmm_ac_bk_cwmin<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>
wmm_ac_bk_cwmax<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>
wmm_ac_bk_aifs<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>
wmm_ac_bk_txop_limit<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
wmm_ac_bk_acm<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
wmm_ac_be_aifs<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
wmm_ac_be_cwmin<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>
wmm_ac_be_cwmax<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>
wmm_ac_be_txop_limit<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
wmm_ac_be_acm<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
wmm_ac_vi_aifs<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
wmm_ac_vi_cwmin<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
wmm_ac_vi_cwmax<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>
wmm_ac_vi_txop_limit<span style="color:#f92672">=</span><span style="color:#ae81ff">94</span>
wmm_ac_vi_acm<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
wmm_ac_vo_aifs<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
wmm_ac_vo_cwmin<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
wmm_ac_vo_cwmax<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
wmm_ac_vo_txop_limit<span style="color:#f92672">=</span><span style="color:#ae81ff">47</span>
wmm_ac_vo_acm<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
ht_capab<span style="color:#f92672">=[</span>SHORT-GI-40<span style="color:#f92672">]</span>
eapol_key_index_workaround<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
eap_server<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
own_ip_addr<span style="color:#f92672">=</span><span style="color:#ae81ff">127</span>.0.0.1
wpa<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
wpa_passphrase<span style="color:#f92672">=</span>Helecomm1
wpa_key_mgmt<span style="color:#f92672">=</span>WPA-PSK
rsn_pairwise<span style="color:#f92672">=</span>CCMP
ssid<span style="color:#f92672">=</span>ghome2</code></pre></div></li>
</ul>

<h3 id="default-service">Default service</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rc-update add hostapd default
rc-update add dhcpd default
rc-update add net.wlan0 default</code></pre></div>
</article>

    </body>
</html>
