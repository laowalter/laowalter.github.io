<!DOCTYPE html>
<html>
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie-edge">

    
    
    <link rel="stylesheet" href="/laowalter.github.io/sass/main.min.ef740697b92983f94ae209bb0e3184554cbc28dcfc08832347dacd426dc8d3a2.css">

</head>

    
<head>
    
    

    
    
    <link href="laowalter.github.iocss/section_number/section_number.css" rel="stylesheet" type="text/css">
    
</head>

    <body>

    <h1>Encrypt Filesystem / 加密文件系统</h1>
    <p>Mon Jan 1, 0001</p>
    
    <a class="tag tag--primary tag--small"   href="laowalter.github.io"><font color="green">Home</font></a>

    
        
           <a class="tag tag--primary tag--small" href="laowalter.github.io/tags/linux">linux</a>
        
           <a class="tag tag--primary tag--small" href="laowalter.github.io/tags/encrypt">encrypt</a>
        
    

    <hr><br>
<nav id="TableOfContents">
<ul>
<li><a href="#dm-crypt-加密文件系统镜像">dm-crypt 加密文件系统镜像</a>
<ul>
<li><a href="#数据包准备">数据包准备</a>
<ul>
<li><a href="#安装">安装</a></li>
<li><a href="#检查dm-crpyt是否已经加载">检查dm-crpyt是否已经加载</a></li>
</ul></li>
<li><a href="#创建加密文件镜像">创建加密文件镜像</a>
<ul>
<li><a href="#创建一个100m的加密镜像">创建一个100M的加密镜像</a></li>
<li><a href="#挂载">挂载</a></li>
<li><a href="#卸载">卸载</a></li>
</ul></li>
<li><a href="#建立两个batch文件">建立两个batch文件</a></li>
<li><a href="#权限设置">权限设置</a>
<ul>
<li><a href="#find-the-uuid">Find the &ldquo;UUID&rdquo;</a></li>
</ul></li>
<li><a href="#etc-udev-rules-d-99-myencryptfs-rules">/etc/udev/rules.d/99-myencryptfs.rules</a></li>
</ul></li>
</ul></li>
</ul>
</nav><article>
    

<h2 id="dm-crypt-加密文件系统镜像">dm-crypt 加密文件系统镜像</h2>

<h3 id="数据包准备">数据包准备</h3>

<h4 id="安装">安装</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root# emerge -avq sys-fs/lvm2 
root# emerge -avq sys-fs/cryptsetup</code></pre></div>
<h4 id="检查dm-crpyt是否已经加载">检查dm-crpyt是否已经加载</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls -l /dev/mapper/control <span style="color:#75715e"># 接下来加载dm-crypt内核模块：
</span><span style="color:#75715e"></span>$ sudo modprobe dm-crypt <span style="color:#75715e"># dm-crypt加载后，它会用device-mapper自动注册。
</span><span style="color:#75715e"></span>$ sudo dmsetup targets <span style="color:#75715e"># 应该看到crypt的下列输出：
</span><span style="color:#75715e"></span>crypt            v1.1.0
striped          v1.0.2
linear           v1.0.1
error            v1.0.1</code></pre></div>
<h3 id="创建加密文件镜像">创建加密文件镜像</h3>

<h4 id="创建一个100m的加密镜像">创建一个100M的加密镜像</h4>

<ul>
<li>bsxcount=100M</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>/dev/zero of<span style="color:#f92672">=</span>~/secret.img bs<span style="color:#f92672">=</span>1M count<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span></code></pre></div>
<ul>
<li>连接 dev/loop0 到加密镜像文件</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo losetup /dev/loop0 ~/secret.img</code></pre></div>
<h4 id="挂载">挂载</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo cryptsetup -y create encryptfs /dev/loop0
$ sudo dmsetup ls
$ sudo mkfs.ext4 /dev/mapper/encryptfs
$ mkdir encryptfs
$ sudo mount /dev/mapper/encryptfs ~/encrypfs</code></pre></div>
<h4 id="卸载">卸载</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo umount ~/encrypfs
$ sudo crpytsetup remove encryptfs
$ sudo losetup -d /dev/loop0</code></pre></div>
<h3 id="建立两个batch文件">建立两个batch文件</h3>

<p>%filename: ~/.bin/loadEncryptFilesystem.sh</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>
sudo losetup /dev/loop0 /data/encryptimg/secret.img
sudo cryptsetup create encryptfs /dev/loop0
sudo mount /dev/mapper/encryptfs /home/walter/encryptfs</code></pre></div>
<p>%filename: ~/.bin/unloadEncryptFilesystem.sh</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
sudo umount /home/walter/encryptfs
sudo cryptsetup remove encryptfs
sudo losetup -d /dev/loop0</code></pre></div>
<h3 id="权限设置">权限设置</h3>

<p>为了让指定用户可以访问加密系统，可以通过udev rules 的设置赋予指定用户权限。</p>

<h4 id="find-the-uuid">Find the &ldquo;UUID&rdquo;</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo blkid /dev/mapper/encryptfs
/dev/mapper/encryptfs: UUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;c086c30c-bea0-452f-8616-0a3a6d9f48b3&#34;</span> TYPE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ext4&#34;</span></code></pre></div>
<h3 id="etc-udev-rules-d-99-myencryptfs-rules">/etc/udev/rules.d/99-myencryptfs.rules</h3>

<p>%filename:  /etc/udev/rules.d/99-myencryptfs.rules</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">KERNEL<span style="color:#f92672">==</span><span style="color:#e6db74">&#34;loop0&#34;</span> ENV<span style="color:#f92672">{</span>ID_FS_UUID<span style="color:#f92672">}==</span><span style="color:#e6db74">&#34;c086c30c-bea0-452f-8616-0afa9848b3&#34;</span> MODE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0600&#34;</span> OWNER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;user&#34;</span> GROUP<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;group&#34;</span></code></pre></div>
<p>#KERNEL==&ldquo;loop5&rdquo; MODE=&ldquo;0600&rdquo; OWNER=&ldquo;MyUser&rdquo; GROUP=&ldquo;MyGroupUser&rdquo; ENV{UDISKS_IGNORE}=&ldquo;1&rdquo; ENV{UDISKS_PRESENTATION_HIDE}=&ldquo;1&rdquo; ENV{ID_DRIVE_EJECTABLE}=&ldquo;0&rdquo;</p>

</article>

    </body>
</html>
